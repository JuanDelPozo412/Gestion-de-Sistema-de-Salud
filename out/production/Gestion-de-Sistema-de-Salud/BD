CREATE TABLE Usuario (
    idUsuario       INT AUTO_INCREMENT PRIMARY KEY,
    nombre          VARCHAR(50)  NOT NULL,
    apellido        VARCHAR(50)  NOT NULL,
    email           VARCHAR(100) NOT NULL UNIQUE,
    dni             VARCHAR(50)  NOT NULL UNIQUE,
    contrasenia     VARCHAR(255) NOT NULL,
    fechaNacimiento DATE         NOT NULL,
    tipo_usuario    ENUM('PACIENTE', 'MEDICO', 'ADMINISTRADOR') NOT NULL
);

CREATE TABLE Plan (
    idPlan         INT AUTO_INCREMENT PRIMARY KEY,
    nombre         VARCHAR(100) NOT NULL,
    descripcion    TEXT         NOT NULL,
    costoMensual   DECIMAL(10,2) NOT NULL,
    cobertura      VARCHAR(255) NOT NULL
);

CREATE TABLE Paciente (
    idUsuario   INT PRIMARY KEY,
    direccion   VARCHAR(200),
    idPlan      INT,
    FOREIGN KEY (idUsuario) REFERENCES Usuario(idUsuario),
    FOREIGN KEY (idPlan)    REFERENCES Plan(idPlan)
);

CREATE TABLE Medico (
    idUsuario    INT PRIMARY KEY,
    especialidad ENUM(
      'CLINICO',
      'DERMATOLOGO',
      'CARDIOLOGO',
      'OCULISTA',
      'TRAUMATOLOGO',
      'ONCOLOGO'
    ) NOT NULL,
    FOREIGN KEY (idUsuario) REFERENCES Usuario(idUsuario)
);

CREATE TABLE Admin (
    idUsuario INT PRIMARY KEY,
    cargo     VARCHAR(100),
    FOREIGN KEY (idUsuario) REFERENCES Usuario(idUsuario)
);

CREATE TABLE Historial (
    idHistorial        INT AUTO_INCREMENT PRIMARY KEY,
    fechaActualizacion DATETIME NOT NULL,
    idPaciente         INT      NOT NULL,
    idMedico           INT      NOT NULL,
    FOREIGN KEY (idPaciente) REFERENCES Paciente(idUsuario),
    FOREIGN KEY (idMedico)   REFERENCES Medico(idUsuario)
);

CREATE TABLE Consulta (
    idConsulta       INT AUTO_INCREMENT PRIMARY KEY,
    idHistorial      INT  NOT NULL,
    idPaciente       INT  NOT NULL,
    idMedico         INT  NOT NULL,
    detallesConsulta TEXT,
    FOREIGN KEY (idHistorial) REFERENCES Historial(idHistorial),
    FOREIGN KEY (idPaciente)  REFERENCES Paciente(idUsuario),
    FOREIGN KEY (idMedico)    REFERENCES Medico(idUsuario)
);

CREATE TABLE Turno (
    idTurno          INT AUTO_INCREMENT PRIMARY KEY,
    idPaciente       INT          NOT NULL,
    idMedico         INT          NOT NULL,
    fechaTurno       DATE         NOT NULL,
    horaTurno        TIME         NOT NULL,
    estado           ENUM('ACTIVO','CANCELADO') NOT NULL DEFAULT 'ACTIVO',
    fechaReservacion DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    fechaCancelacion DATETIME     NULL,
    FOREIGN KEY (idPaciente)  REFERENCES Paciente(idUsuario),
    FOREIGN KEY (idMedico)    REFERENCES Medico(idUsuario),
    UNIQUE (idMedico, fechaTurno, horaTurno)
);

CREATE INDEX idx_turno_paciente ON Turno(idPaciente);
CREATE INDEX idx_turno_medico_fecha_hora ON Turno(idMedico, fechaTurno, horaTurno);